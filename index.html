<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Estrategia de Inversi√≥n a Largo Plazo</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f7f9;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: auto;
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        label {
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9em;
        }
        input[type="number"] {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
        }
        button {
            grid-column: 1 / -1;
            padding: 12px 20px;
            font-size: 1.1em;
            font-weight: bold;
            color: #fff;
            background-color: #3498db;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px 12px;
            text-align: right;
            white-space: nowrap;
        }
        th {
            background-color: #ecf0f1;
            color: #2c3e50;
            font-weight: bold;
        }
        tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .risk-analysis {
            margin-top: 30px;
            padding: 15px;
            background-color: #fffbe6;
            border-left: 5px solid #f39c12;
        }
        #chart-container {
            margin-top: 30px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Simulador de Estrategia de Inversi√≥n üìà</h1>
    <p>Introduce los par√°metros de tu estrategia para calcular la distribuci√≥n de la inversi√≥n, simular cada fase y determinar los precios de venta necesarios.</p>
    
    <div id="input-section">
        <h2>Par√°metros de la Simulaci√≥n</h2>
        <form id="simulationForm" class="form-grid">
            <div class="form-group">
                <label for="capitalMaximo">Capital M√°ximo Total (‚Ç¨):</label>
                <input type="number" id="capitalMaximo" value="10000" step="1000" min="0">
            </div>
            <div class="form-group">
                <label for="caidaRecompra">% Ca√≠da para Recompra (PCx):</label>
                <input type="number" id="caidaRecompra" value="10" step="0.5" min="0.1" max="99.9">
            </div>
            <div class="form-group">
                <label for="precioMinimo">Precio M√≠nimo de Compra (‚Ç¨):</label>
                <input type="number" id="precioMinimo" value="5" step="0.1" min="0.01">
            </div>
            <div class="form-group">
                <label for="gananciaDeseada">% Ganancia Adicional Deseado:</label>
                <input type="number" id="gananciaDeseada" value="15" step="1" min="0.1">
            </div>
            <div class="form-group">
                <label for="accionesGratuitas">% Acciones 'Gratuitas' a Conservar:</label>
                <input type="number" id="accionesGratuitas" value="10" step="1" min="0" max="99.9">
            </div>
             <div class="form-group">
                <label for="accionesIniciales">Acciones (Primera Compra):</label>
                <input type="number" id="accionesIniciales" value="50" min="1">
            </div>
            <div class="form-group">
                <label for="precioInicial">Precio por Acci√≥n (Primera Compra) (‚Ç¨):</label>
                <input type="number" id="precioInicial" value="20" step="0.1" min="0.01">
            </div>
            <button type="button" onclick="runSimulation()">Calcular Simulaci√≥n</button>
        </form>
    </div>

    <div id="results-section">
        <h2>Tabla de Resultados</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Fase de Compra</th>
                        <th>Acciones Compradas</th>
                        <th>Acciones Totales</th>
                        <th>Capital Restante (‚Ç¨)</th>
                        <th>Acciones 'Gratuitas' (% y Cantidad)</th>
                        <th>Precio de la Acci√≥n (‚Ç¨)</th>
                        <th>Inversi√≥n en Fase (‚Ç¨)</th>
                        <th>Inversi√≥n Acumulada (‚Ç¨)</th>
                        <th>PPM (‚Ç¨)</th>
                        <th>Precio Venta Necesario (‚Ç¨)</th>
                        <th>Ganancia Total al Vender (‚Ç¨)</th>
                        <th>Ca√≠da % (desde anterior)</th>
                        <th>Acciones a Vender</th>
                    </tr>
                </thead>
                <tbody id="resultsTableBody">
                    </tbody>
            </table>
        </div>
    </div>
    
    <div id="chart-container" style="display:none;">
        <h2>Visualizaci√≥n Gr√°fica</h2>
        <canvas id="investmentChart"></canvas>
    </div>

    <div id="riskAnalysisSection" class="risk-analysis" style="display:none;">
        <h2>An√°lisis de Riesgos Clave</h2>
        <div id="riskContent"></div>
    </div>

</div>

<script>
// Variable global para mantener la instancia del gr√°fico Chart.js
let investmentChartInstance = null;

function formatCurrency(value) {
    return value.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' });
}

function formatNumber(value, decimals = 2) {
    if (isNaN(value) || !isFinite(value)) {
        return '-';
    }
    return value.toLocaleString('es-ES', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
}

function runSimulation() {
    // 1. OBTENER PAR√ÅMETROS DEL FORMULARIO
    const capitalMaximo = parseFloat(document.getElementById('capitalMaximo').value);
    const pcx = parseFloat(document.getElementById('caidaRecompra').value);
    const precioMinimo = parseFloat(document.getElementById('precioMinimo').value);
    const gananciaDeseada = parseFloat(document.getElementById('gananciaDeseada').value);
    const porcAccionesGratuitas = parseFloat(document.getElementById('accionesGratuitas').value);
    const accionesIniciales = parseFloat(document.getElementById('accionesIniciales').value);
    const precioInicial = parseFloat(document.getElementById('precioInicial').value);

    const resultsTableBody = document.getElementById('resultsTableBody');
    resultsTableBody.innerHTML = ''; // Limpiar resultados anteriores

    // Limpiar y ocultar el gr√°fico y el an√°lisis de riesgos
    document.getElementById('chart-container').style.display = 'none';
    document.getElementById('riskAnalysisSection').style.display = 'none';

    // Basic input validation
    if (isNaN(capitalMaximo) || capitalMaximo <= 0 ||
        isNaN(pcx) || pcx <= 0 || pcx >= 100 || 
        isNaN(precioMinimo) || precioMinimo <= 0 ||
        isNaN(gananciaDeseada) || gananciaDeseada <= 0 || 
        isNaN(porcAccionesGratuitas) || porcAccionesGratuitas < 0 || porcAccionesGratuitas >= 100 || 
        isNaN(accionesIniciales) || accionesIniciales <= 0 ||
        isNaN(precioInicial) || precioInicial <= 0) {
        resultsTableBody.innerHTML = `<tr><td colspan="13" style="color: red; text-align: center;">Error: Por favor, introduce valores v√°lidos y positivos en todos los campos. Los porcentajes deben estar entre 0 y 100 (excluyendo 100).</td></tr>`;
        return;
    }


    let capitalRestante = capitalMaximo;
    let accionesTotales = 0;
    let inversionAcumulada = 0;
    let precioAnterior = 0;
    let recompraCount = 0; // Para llevar la cuenta de las recompras realizadas

    // Arrays para los datos del gr√°fico
    const labels = [];
    const ppmData = [];
    const precioVentaNecesarioData = [];
    const precioAccionData = []; 

    // 2. FASE 0: PRIMERA COMPRA
    const inversionInicial = accionesIniciales * precioInicial;
    if (inversionInicial > capitalMaximo) {
        resultsTableBody.innerHTML = `<tr><td colspan="13" style="color: red; text-align: center;">Error: La inversi√≥n inicial (${formatCurrency(inversionInicial)}) excede el capital m√°ximo total (${formatCurrency(capitalMaximo)}).</td></tr>`;
        return;
    }

    capitalRestante -= inversionInicial;
    accionesTotales = accionesIniciales;
    inversionAcumulada = inversionInicial;
    let ppm = precioInicial;
    precioAnterior = precioInicial;

    // Calcular objetivos de venta para la Fase 0
    let capitalObjetivo = inversionAcumulada * (1 + gananciaDeseada / 100);
    let cantidadAccionesGratuitas = accionesTotales * (porcAccionesGratuitas / 100);
    let accionesAVender = accionesTotales - cantidadAccionesGratuitas;
    let precioVentaNecesario = accionesAVender > 0 ? capitalObjetivo / accionesAVender : 0;
    
    let gananciaTotalEsperada = capitalObjetivo - inversionAcumulada;
    if (gananciaTotalEsperada < 0) gananciaTotalEsperada = 0; 

    // A√±adir datos para la tabla
    let newRow = `<tr>
        <td>Primera Compra</td>
        <td>${formatNumber(accionesIniciales, 0)}</td>
        <td>${formatNumber(accionesTotales, 2)}</td>
        <td>${formatCurrency(capitalRestante)}</td>
        <td>${porcAccionesGratuitas}% (${formatNumber(cantidadAccionesGratuitas, 2)})</td>
        <td>${formatCurrency(precioInicial)}</td>
        <td>${formatCurrency(inversionInicial)}</td>
        <td>${formatCurrency(inversionAcumulada)}</td>
        <td>${formatCurrency(ppm)}</td>
        <td><b>${formatCurrency(precioVentaNecesario)}</b></td>
        <td>${formatCurrency(gananciaTotalEsperada)}</td>
        <td>-</td>
        <td>${formatNumber(accionesAVender, 2)}</td>
    </tr>`;
    resultsTableBody.innerHTML += newRow;

    // A√±adir datos para el gr√°fico
    labels.push("Primera Compra");
    ppmData.push(ppm);
    precioVentaNecesarioData.push(precioVentaNecesario);
    precioAccionData.push(precioInicial);


    // 3. FASES DE RECOMPRA (PC1, PC2, ...) - Ahora din√°mico
    while (true) {
        const proximoPrecioRecompra = precioAnterior * (1 - pcx / 100);

        // Criterios de parada
        if (proximoPrecioRecompra < precioMinimo) {
            resultsTableBody.innerHTML += `<tr><td colspan="13" style="color: orange; text-align: center;">Simulaci√≥n finalizada: El precio de recompra proyectado (${formatCurrency(proximoPrecioRecompra)}) es inferior al m√≠nimo de compra (${formatCurrency(precioMinimo)}).</td></tr>`;
            break;
        }

        // Si el capital restante es demasiado bajo para comprar al menos una acci√≥n
        // o si el capital restante es cero o negativo
        if (capitalRestante <= 0.01 || capitalRestante < proximoPrecioRecompra) {
            resultsTableBody.innerHTML += `<tr><td colspan="13" style="color: orange; text-align: center;">Simulaci√≥n finalizada: Capital insuficiente para comprar m√°s acciones al precio de ${formatCurrency(proximoPrecioRecompra)}.</td></tr>`;
            break;
        }
        
        recompraCount++;
        let inversionEnFase = capitalRestante; // Se invierte todo el capital restante para la siguiente recompra

        const accionesCompradas = inversionEnFase / proximoPrecioRecompra;
        
        // Si las acciones compradas son insignificantes, detener (ej. menos de 0.001 de acci√≥n)
        if (accionesCompradas < 0.001) { 
             resultsTableBody.innerHTML += `<tr><td colspan="13" style="color: orange; text-align: center;">Simulaci√≥n finalizada: Cantidad de acciones a comprar insignificante.</td></tr>`;
             break;
        }

        // Actualizar totales
        capitalRestante -= inversionEnFase;
        accionesTotales += accionesCompradas;
        inversionAcumulada += inversionEnFase;
        ppm = inversionAcumulada / accionesTotales;
        precioAnterior = proximoPrecioRecompra;

        // Calcular objetivos de venta para la fase actual
        capitalObjetivo = inversionAcumulada * (1 + gananciaDeseada / 100);
        cantidadAccionesGratuitas = accionesTotales * (porcAccionesGratuitas / 100);
        accionesAVender = accionesTotales - cantidadAccionesGratuitas;
        precioVentaNecesario = accionesAVender > 0 ? capitalObjetivo / accionesAVender : 0;

        gananciaTotalEsperada = capitalObjetivo - inversionAcumulada;
        if (gananciaTotalEsperada < 0) gananciaTotalEsperada = 0; 

        // A√±adir datos para la tabla
        newRow = `<tr>
            <td>Recompra PC${recompraCount}</td>
            <td>${formatNumber(accionesCompradas, 2)}</td>
            <td>${formatNumber(accionesTotales, 2)}</td>
            <td>${formatCurrency(capitalRestante)}</td>
            <td>${porcAccionesGratuitas}% (${formatNumber(cantidadAccionesGratuitas, 2)})</td>
            <td>${formatCurrency(proximoPrecioRecompra)}</td>
            <td>${formatCurrency(inversionEnFase)}</td>
            <td>${formatCurrency(inversionAcumulada)}</td>
            <td>${formatCurrency(ppm)}</td>
            <td><b>${formatCurrency(precioVentaNecesario)}</b></td>
            <td>${formatCurrency(gananciaTotalEsperada)}</td>
            <td>${formatNumber(pcx)}%</td>
            <td>${formatNumber(accionesAVender, 2)}</td>
        </tr>`;
        resultsTableBody.innerHTML += newRow;

        // A√±adir datos para el gr√°fico
        labels.push(`PC${recompraCount}`);
        ppmData.push(ppm);
        precioVentaNecesarioData.push(precioVentaNecesario);
        precioAccionData.push(proximoPrecioRecompra);
    }
    
    // 4. MOSTRAR GR√ÅFICO
    document.getElementById('chart-container').style.display = 'block';
    const ctx = document.getElementById('investmentChart').getContext('2d');

    // Destruye el gr√°fico anterior si existe para evitar superposiciones
    if (investmentChartInstance) {
        investmentChartInstance.destroy();
    }

    investmentChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'PPM (‚Ç¨)',
                    data: ppmData,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.2,
                    fill: false,
                    pointRadius: 5,
                    pointHoverRadius: 7
                },
                {
                    label: 'Precio Venta Necesario (‚Ç¨)',
                    data: precioVentaNecesarioData,
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    tension: 0.2,
                    fill: false,
                    pointRadius: 5,
                    pointHoverRadius: 7
                },
                {
                    label: 'Precio de la Acci√≥n (‚Ç¨)',
                    data: precioAccionData,
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    tension: 0.2,
                    fill: false,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    mode: 'index',
                    intersect: false
                },
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: '#333'
                    }
                },
                title: {
                    display: true,
                    text: 'Evoluci√≥n de Precios y Puntos de Venta',
                    font: {
                        size: 16
                    },
                    color: '#2c3e50'
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    title: {
                        display: true,
                        text: 'Valor (‚Ç¨)',
                        color: '#555'
                    },
                    ticks: {
                        callback: function(value, index, ticks) {
                            return formatCurrency(value); // Formatear los ticks del eje Y como moneda
                        }
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Fase de Inversi√≥n',
                        color: '#555'
                    }
                }
            }
        }
    });

    // 5. MOSTRAR AN√ÅLISIS DE RIESGOS
    document.getElementById('riskAnalysisSection').style.display = 'block';
    document.getElementById('riskContent').innerHTML = `
        <ul>
            <li><strong>Gesti√≥n del Capital:</strong> La estrategia ahora realiza el m√°ximo n√∫mero de recompras posibles, invirtiendo el capital restante en cada fase. Esto significa que todo el capital m√°ximo (${formatCurrency(capitalMaximo)}) se asignar√° a compras hasta agotar el fondo o alcanzar el precio m√≠nimo. El capital restante final es de <strong>${formatCurrency(capitalRestante)}</strong>, que es el remanente no utilizado o no asignable.</li>
            <li><strong>Riesgo de Concentraci√≥n:</strong> Al invertir repetidamente en un √∫nico activo que est√° cayendo, aumentas la concentraci√≥n y el riesgo espec√≠fico de esa empresa o sector. Una falta de recuperaci√≥n a largo plazo podr√≠a resultar en una p√©rdida significativa del capital invertido.</li>
            <li><strong>Dependencia de la Recuperaci√≥n (Riesgo "No Vender con P√©rdidas"):</strong> El principio de no vender por debajo del Precio Promedio de Compra (PPM) te protege de realizar p√©rdidas, pero te ata al activo indefinidamente si no recupera su valor. El capital permanece bloqueado, generando un alto coste de oportunidad. El √©xito de la estrategia depende 100% de que el precio del activo eventualmente supere tu <strong>Precio de Venta Necesario</strong>.</li>
             <li><strong>Riesgo de "Cuchillo que Cae" (Catching a Falling Knife):</strong> Comprar activos en ca√≠das sucesivas es arriesgado. Si la ca√≠da se debe a problemas fundamentales del activo (y no a una correcci√≥n de mercado), el precio podr√≠a no recuperarse nunca, invalidando la premisa de la estrategia.</li>
        </ul>
    `;
}

// Ejecutar una simulaci√≥n inicial al cargar la p√°gina con los valores por defecto
window.onload = runSimulation;
</script>

</body>
</html>
