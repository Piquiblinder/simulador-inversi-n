<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Simulador de Estrategia de Inversi√≥n Universal</title>
    <style>
        /* Paleta de colores */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                "Helvetica Neue", Arial, sans-serif;
            background-color: #000000;
            color: #f4f7f9;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: auto;
            background: #222222;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        h1,
        h2 {
            color: #3498db;
            border-bottom: 2px solid #3498db;
            padding-bottom: 12px;
            margin-bottom: 25px;
            text-align: center;
        }
        h2 {
            text-align: left;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }
        label {
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 0.95em;
            color: #ccc;
        }
        input[type="number"],
        select {
            padding: 12px;
            border: 1px solid #555;
            border-radius: 6px;
            font-size: 1em;
            width: 100%;
            box-sizing: border-box;
            background-color: #333333;
            color: #f4f7f9;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        input[type="number"]:focus,
        select:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.4);
            outline: none;
        }
        input[type="number"]:disabled,
        select:disabled {
            background-color: #444444;
            cursor: not-allowed;
            color: #888;
        }
        button {
            grid-column: 1 / -1;
            padding: 14px 25px;
            font-size: 1.15em;
            font-weight: bold;
            color: #fff;
            background-color: #3498db;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        button:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }
        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .table-container {
            overflow-x: auto;
            margin-top: 30px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 8px;
            overflow: hidden;
        }
        th,
        td {
            border: 1px solid #444444;
            padding: 12px 15px;
            text-align: right;
            white-space: nowrap;
            background-color: #333333;
            color: #f4f7f9;
        }
        th {
            background-color: #3a3a3a;
            color: #fff;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9em;
        }
        tbody tr:nth-child(even) {
            background-color: #2b2b2b;
        }
        tbody tr:hover {
            background-color: #4a4a4a;
        }
        .risk-analysis {
            margin-top: 40px;
            padding: 20px;
            background-color: #3a3a3a;
            border-left: 6px solid #f39c12;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            line-height: 1.6;
            color: #e0e0e0;
        }
        .risk-analysis h2 {
            border-bottom: 2px solid #f39c12;
            padding-bottom: 8px;
            margin-bottom: 15px;
            color: #f39c12;
        }
        .risk-analysis ul {
            padding-left: 1.2em;
            margin: 0;
        }
        .risk-analysis li {
            margin-bottom: 8px;
        }
        /* Short (Rojo) */
        body.short h1,
        body.short h2 {
            border-bottom-color: #e74c3c;
            color: #e74c3c;
        }
        body.short button {
            background-color: #e74c3c;
        }
        body.short button:hover {
            background-color: #c0392b;
        }
        body.short input[type="number"]:focus,
        body.short select:focus {
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.4);
        }
        body.short .risk-analysis {
            background-color: #4a3a3a;
            border-left-color: #e74c3c;
        }
        body.short .risk-analysis h2 {
            border-bottom-color: #e74c3c;
        }
        .margin-call-row {
            background-color: #a00 !important;
            color: white !important;
            font-weight: bold;
        }
        .margin-call-row td {
            color: white !important;
        }

        /* --- ESTILOS RESPONSIVOS PARA M√ìVILES Y TABLETAS --- */
        @media (max-width: 768px) {
            body {
                padding: 10px; /* Menos espacio en los bordes de la pantalla */
                font-size: 16px; /* Asegura un tama√±o de fuente base legible */
            }

            .container {
                padding: 15px; /* Menos padding dentro del contenedor principal */
            }

            h1 {
                font-size: 1.7em; /* Tama√±o de t√≠tulo m√°s adecuado para m√≥viles */
            }

            h2 {
                font-size: 1.4em;
            }

            /* El grid del formulario ya es responsivo por `auto-fill` y `minmax` */
            .form-grid {
                gap: 20px; /* Espacio ligeramente menor entre campos */
            }
            
            label {
                font-size: 0.9em;
            }
            
            input[type="number"],
            select {
                padding: 14px; /* Facilita el toque en pantallas t√°ctiles */
            }

            button {
                font-size: 1.1em;
            }
            
            /* Indicador visual para que el usuario sepa que la tabla es deslizable */
            .table-container::before {
                content: '¬´ Desliza la tabla para ver todas las columnas ¬ª';
                display: block;
                text-align: center;
                margin-bottom: 12px;
                font-size: 0.85em;
                color: #f39c12;
                font-style: italic;
            }

            th, td {
                padding: 10px 8px; /* Compacta un poco m√°s las celdas de la tabla */
            }
        }
    </style>
</head>
<body onload="updateLabels()">
    <div class="container">
        <h1 id="mainTitle">
            Simulador de Estrategia de Inversi√≥n Universal <span id="mainIcon">üíπ</span>
        </h1>

        <div id="input-section">
            <h2>Par√°metros de la Simulaci√≥n</h2>
            <form id="simulationForm" class="form-grid" onsubmit="event.preventDefault(); runSimulation();">
                <!-- El resto de tu formulario HTML aqu√≠ (sin cambios) -->
                <div class="form-group">
                    <label for="assetType">Tipo de Activo:</label>
                    <select id="assetType" onchange="updateLabels()">
                        <option value="acciones">Acciones</option>
                        <option value="futuros">Futuros</option>
                    </select>
                </div>
                <div class="form-group" id="operationTypeGroup" style="display: none;">
                    <label for="operationType">Tipo de Operaci√≥n:</label>
                    <select id="operationType" onchange="updateLabels()">
                        <option value="long">Long (Compra)</option>
                        <option value="short">Short (Venta)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="capitalMaximo" id="labelCapitalMaximo">Capital M√°ximo Total (‚Ç¨):</label>
                    <input type="number" id="capitalMaximo" value="1000" step="any" min="0" />
                </div>
                <div class="form-group">
                    <label for="pctCambio" id="labelPctCambio">% Movimiento para A√±adir Posici√≥n:</label>
                    <input
                        type="number"
                        id="pctCambio"
                        value="10"
                        step="any"
                        min="0.1"
                        max="99.9"
                    />
                </div>
                <div class="form-group">
                    <label for="precioLimite" id="labelPrecioLimite"
                        >Precio L√≠mite de la Operaci√≥n (‚Ç¨):</label
                    >
                    <input type="number" id="precioLimite" value="5" step="any" min="0.01" />
                </div>
                <div class="form-group">
                    <label for="gananciaDeseada" id="labelGananciaDeseada"
                        >% Ganancia Deseada en ‚Ç¨ (al cerrar):</label
                    >
                    <input type="number" id="gananciaDeseada" value="15" step="any" min="0.1" />
                </div>
                <div class="form-group" id="groupPorcUnidadesARetener">
                    <label for="porcUnidadesARetener" id="labelPorcUnidadesARetener"
                        >% Acciones a Retener:</label
                    >
                    <input
                        type="number"
                        id="porcUnidadesARetener"
                        value="10"
                        step="any"
                        min="0"
                        max="99.9"
                    />
                </div>
                <div class="form-group">
                    <label for="unidadesIniciales" id="labelUnidadesIniciales"
                        >Acciones Iniciales (1¬™ Compra):</label
                    >
                    <input type="number" id="unidadesIniciales" value="50" step="1" min="1" />
                </div>
                <div class="form-group">
                    <label for="precioInicial" id="labelPrecioInicial"
                        >Precio Inicial por Acci√≥n (1¬™ Compra) (‚Ç¨):</label
                    >
                    <input type="number" id="precioInicial" value="10" step="any" min="0.01" />
                </div>

                <div
                    class="form-group futures-field"
                    style="display: none;"
                    title="Campos espec√≠ficos para futuros"
                >
                    <label for="margenInicialContrato" id="labelMargenInicialContrato"
                        >Margen Inicial por Contrato (‚Ç¨):</label
                    >
                    <input
                        type="number"
                        id="margenInicialContrato"
                        value="500"
                        step="any"
                        min="0"
                    />
                </div>
                <div class="form-group futures-field" style="display: none;" title="Campos espec√≠ficos para futuros">
                    <label for="margenMantenimientoContrato" id="labelMargenMantenimientoContrato"
                        >Margen Mantenimiento por Contrato (‚Ç¨):</label
                    >
                    <input
                        type="number"
                        id="margenMantenimientoContrato"
                        value="400"
                        step="any"
                        min="0"
                    />
                </div>
                <div class="form-group futures-field" style="display: none;" title="Campos espec√≠ficos para futuros">
                    <label for="comisionContrato" id="labelComisionContrato"
                        >Comisi√≥n por Contrato (‚Ç¨):</label
                    >
                    <input
                        type="number"
                        id="comisionContrato"
                        value="2.5"
                        step="any"
                        min="0"
                    />
                </div>
                <div class="form-group futures-field" style="display: none;" title="Campos espec√≠ficos para futuros">
                    <label for="tamanoTick" id="labelTamanoTick">Tama√±o del Tick (‚Ç¨):</label>
                    <input
                        type="number"
                        id="tamanoTick"
                        value="0.25"
                        step="any"
                        min="0.01"
                    />
                </div>
                <div class="form-group futures-field" style="display: none;" title="Campos espec√≠ficos para futuros">
                    <label for="valorTick" id="labelValorTick">Valor del Tick (‚Ç¨):</label
                    >
                    <input
                        type="number"
                        id="valorTick"
                        value="12.5"
                        step="any"
                        min="0.01"
                    />
                </div>

                <div
                    class="form-group"
                    style="grid-column: 1 / -1; margin-top: 20px;"
                    title="Estrategias para a√±adir nuevas unidades/contratos"
                >
                    <label for="additionStrategy">Estrategia de Adici√≥n de Unidades:</label>
                    <select id="additionStrategy" onchange="toggleAdditionFields()">
                        <option value="distributeCapital"
                            >1. Distribuir Capital Equitativamente</option
                        >
                        <option value="fixedUnits">2. Mismo N√∫mero de Unidades por Fase</option>
                        <option value="fixedPctInitialCapital">
                            3. Porcentaje Fijo del Capital Inicial por Fase
                        </option>
                        <option value="growingUnits">
                            4. Porcentaje Creciente del Capital por Fase (Escalado)
                        </option>
                    </select>
                </div>

                <div class="form-group" id="groupFixedUnits" style="display: none;">
                    <label for="fixedUnitsToAdd">Unidades a A√±adir por Fase:</label>
                    <input
                        type="number"
                        id="fixedUnitsToAdd"
                        value="1"
                        step="1"
                        min="1"
                    />
                </div>
                <div class="form-group" id="groupFixedPctInitialCapital" style="display: none;">
                    <label for="fixedPctInitialCapitalToAdd">% Capital Inicial a A√±adir por Fase:</label>
                    <input
                        type="number"
                        id="fixedPctInitialCapitalToAdd"
                        value="10"
                        step="any"
                        min="0.1"
                        max="100"
                    />
                </div>
                <button type="submit" id="simulateButton">Calcular Simulaci√≥n</button>
            </form>
        </div>

        <div id="results-section">
            <h2>Tabla de Resultados</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr id="tableHeaders"></tr>
                    </thead>
                    <tbody id="resultsTableBody"></tbody>
                </table>
            </div>
        </div>

        <div
            id="riskAnalysisSection"
            class="risk-analysis"
            style="display:none;"
            aria-live="polite"
        >
            <h2 id="riskAnalysisTitle">An√°lisis de Riesgos Clave</h2>
            <div id="riskContent"></div>
        </div>
    </div>

    <script>
        // El c√≥digo Javascript no necesita cambios para la responsividad,
        // por lo que se mantiene igual que en la versi√≥n anterior.
        "use strict";

        // -----------------------
        // FORMATEADORES
        // -----------------------
        function formatCurrency(value) {
            if (isNaN(value) || !isFinite(value)) {
                return "-";
            }
            return value.toLocaleString("es-ES", {
                style: "currency",
                currency: "EUR",
            });
        }

        function formatNumber(value, decimals = 2) {
            if (isNaN(value) || !isFinite(value)) {
                return "-";
            }
            return value.toLocaleString("es-ES", {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals,
            });
        }

        // Redondea precio al tick m√°s cercano
        function roundToTick(price, tickSize) {
            if (tickSize <= 0) return price;
            return Math.round(price / tickSize) * tickSize;
        }

        // -----------------------
        // MANEJO DE VISIBILIDAD DE CAMPOS ADICIONALES
        // -----------------------
        function toggleAdditionFields() {
            const additionStrategy =
                document.getElementById("additionStrategy").value;
            document.getElementById("groupFixedUnits").style.display = "none";
            document.getElementById("groupFixedPctInitialCapital").style.display =
                "none";

            if (additionStrategy === "fixedUnits") {
                document.getElementById("groupFixedUnits").style.display = "flex";
            } else if (additionStrategy === "fixedPctInitialCapital") {
                document.getElementById("groupFixedPctInitialCapital").style.display =
                    "flex";
            }
        }

        // -----------------------
        // ACTUALIZAR ETIQUETAS Y VISIBILIDAD
        // -----------------------
        function updateLabels() {
            const assetType = document.getElementById("assetType").value;
            const operationTypeSelect = document.getElementById("operationType");
            const operationTypeGroup = document.getElementById("operationTypeGroup");
            const body = document.body;
            const groupPorcUnidadesARetener = document.getElementById(
                "groupPorcUnidadesARetener"
            );
            const porcUnidadesARetenerInput = document.getElementById(
                "porcUnidadesARetener"
            );
            const futuresFields = document.querySelectorAll(".futures-field");
            let currentOperationType;

            if (assetType === "futuros") {
                operationTypeGroup.style.display = "flex";
                currentOperationType = operationTypeSelect.value;
                futuresFields.forEach((field) => (field.style.display = "flex"));
            } else {
                operationTypeGroup.style.display = "none";
                currentOperationType = "long";
                futuresFields.forEach((field) => (field.style.display = "none"));
            }

            if (currentOperationType === "short") {
                body.classList.add("short");
            } else {
                body.classList.remove("short");
            }

            document.getElementById("mainIcon").textContent = "üíπ";
            document.getElementById("mainTitle").style.textAlign = "center";

            if (assetType === "futuros") {
                groupPorcUnidadesARetener.style.display = "none";
                porcUnidadesARetenerInput.value = 0;
            } else {
                groupPorcUnidadesARetener.style.display = "flex";
                const curVal = porcUnidadesARetenerInput.value;
                if (curVal === "0" || curVal === "") {
                    porcUnidadesARetenerInput.value = 10;
                }
                document.getElementById("labelPorcUnidadesARetener").textContent =
                    "% Acciones en Stake (Sin Coste):";
            }

            document.getElementById("labelGananciaDeseada").textContent =
                "% Ganancia Deseada en ‚Ç¨ (al cerrar):";
            document.getElementById("capitalMaximo").value = 1000;

            if (assetType === "acciones") {
                document.getElementById("pctCambio").value = 10;
                document.getElementById("precioLimite").value = 5;
                document.getElementById("unidadesIniciales").value = 50;
                document.getElementById("precioInicial").value = 10;
                document.getElementById("fixedUnitsToAdd").value = 10;
                document.getElementById("fixedPctInitialCapitalToAdd").value = 10;
                document.getElementById("labelCapitalMaximo").textContent = "Capital M√°ximo Total (‚Ç¨):";
                document.getElementById("labelPctCambio").textContent = "% Ca√≠da para A√±adir Posici√≥n:";
                document.getElementById("labelPrecioLimite").textContent = "Precio L√≠mite de Compra (‚Ç¨):";
                document.getElementById("labelUnidadesIniciales").textContent = "Acciones Iniciales (1¬™ Compra):";
                document.getElementById("labelPrecioInicial").textContent = "Precio Inicial por Acci√≥n (1¬™ Compra) (‚Ç¨):";
            } else {
                document.getElementById("unidadesIniciales").value = 1;
                document.getElementById("fixedUnitsToAdd").value = 1;
                document.getElementById("fixedPctInitialCapitalToAdd").value = 15;
                if (currentOperationType === "long") {
                    document.getElementById("pctCambio").value = 5;
                    document.getElementById("precioLimite").value = 90;
                    document.getElementById("precioInicial").value = 100;
                    document.getElementById("margenInicialContrato").value = 500;
                    document.getElementById("margenMantenimientoContrato").value = 400;
                    document.getElementById("comisionContrato").value = 2.5;
                    document.getElementById("tamanoTick").value = 0.25;
                    document.getElementById("valorTick").value = 12.5;
                    document.getElementById("labelCapitalMaximo").textContent = "Capital/Margen M√°ximo Total (‚Ç¨):";
                    document.getElementById("labelPctCambio").textContent = "% Ca√≠da para A√±adir (Long):";
                    document.getElementById("labelPrecioLimite").textContent = "Precio L√≠mite de Compra (Long) (‚Ç¨):";
                    document.getElementById("labelUnidadesIniciales").textContent = "Contratos Iniciales (1¬™ Operaci√≥n):";
                    document.getElementById("labelPrecioInicial").textContent = "Precio Inicial por Contrato (1¬™ Operaci√≥n) (‚Ç¨):";
                } else {
                    document.getElementById("pctCambio").value = 5;
                    document.getElementById("precioLimite").value = 110;
                    document.getElementById("precioInicial").value = 100;
                    document.getElementById("margenInicialContrato").value = 500;
                    document.getElementById("margenMantenimientoContrato").value = 400;
                    document.getElementById("comisionContrato").value = 2.5;
                    document.getElementById("tamanoTick").value = 0.25;
                    document.getElementById("valorTick").value = 12.5;
                    document.getElementById("labelCapitalMaximo").textContent = "Capital/Margen M√°ximo Total (‚Ç¨):";
                    document.getElementById("labelPctCambio").textContent = "% Subida para A√±adir (Short):";
                    document.getElementById("labelPrecioLimite").textContent = "Precio L√≠mite de Venta (Short) (‚Ç¨):";
                    document.getElementById("labelUnidadesIniciales").textContent = "Contratos Iniciales (1¬™ Operaci√≥n):";
                    document.getElementById("labelPrecioInicial").textContent = "Precio Inicial por Contrato (1¬™ Operaci√≥n) (‚Ç¨):";
                }
            }
            renderTableHeaders(assetType, currentOperationType);
            toggleAdditionFields();
        }

        function renderTableHeaders(assetType, operationType) {
            const tableHeaders = document.getElementById("tableHeaders");
            tableHeaders.innerHTML = "";
            const headersAcciones = [ "Fase de Operaci√≥n", "Acciones A√±adidas", "Acciones Totales", "Capital Restante (‚Ç¨)", "Acciones en Stake (Sin Coste)", "Precio por Acci√≥n (‚Ç¨)", "Inversi√≥n en Fase (‚Ç¨)", "Inversi√≥n Acumulada (‚Ç¨)", "PPM (‚Ç¨)", "Precio Venta Necesario (‚Ç¨)", "Ganancia Total al Vender (‚Ç¨)", "Ca√≠da % (desde anterior)", "Acciones a Vender", ];
            const headersFuturos = [ "Fase de Operaci√≥n", "Unidades A√±adidas", "Contratos Totales", "Capital/Margen Restante (‚Ç¨)", "Margen Req. Actual (‚Ç¨)", "Precio por Unidad (‚Ç¨)", "Margen Usado en Fase (‚Ç¨)", "Margen Acum. Usado (‚Ç¨)", "PPMS (‚Ç¨)", "Precio Cobertura Necesario (‚Ç¨)", "Ganancia Total al Cubrir (‚Ç¨)", "Subida % (desde anterior)", "Unidades a Cubrir", ];
            let headersToUse = assetType === "acciones" ? headersAcciones : headersFuturos;
            headersToUse.forEach((header) => {
                const th = document.createElement("th");
                th.textContent = header;
                if (header === "Fase de Operaci√≥n") {
                    th.style.textAlign = "left";
                }
                tableHeaders.appendChild(th);
            });
            tableHeaders.dataset.columns = headersToUse.length;
        }

        function addResultRow(cellsContentArray, isMarginCall = false) {
            const tbody = document.getElementById("resultsTableBody");
            const tr = document.createElement("tr");
            if (isMarginCall) {
                tr.classList.add("margin-call-row");
            }
            cellsContentArray.forEach((text, idx) => {
                const td = document.createElement("td");
                td.innerHTML = text;
                if (idx === 0) td.style.textAlign = "left";
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        }

        function addMessageRow(message, messageType = "info") {
            const tbody = document.getElementById("resultsTableBody");
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            const colspan = document.getElementById("tableHeaders").dataset.columns || 13;
            td.colSpan = colspan;
            td.style.textAlign = "center";
            td.style.fontWeight = "bold";
            if (messageType === "error") {
                td.style.color = "red";
            } else if (messageType === "warning") {
                td.style.color = "orange";
            } else {
                td.style.color = "#ccc";
            }
            td.innerHTML = message;
            tr.appendChild(td);
            tbody.appendChild(tr);
        }

        function runSimulation() {
            const assetType = document.getElementById("assetType").value;
            const operationType = assetType === "acciones" ? "long" : document.getElementById("operationType").value;
            const additionStrategy = document.getElementById("additionStrategy").value;
            let capitalMaximo = parseFloat(document.getElementById("capitalMaximo").value);
            const pctCambio = parseFloat(document.getElementById("pctCambio").value);
            let precioLimite = parseFloat(document.getElementById("precioLimite").value);
            const gananciaDeseada = parseFloat(document.getElementById("gananciaDeseada").value);
            const porcUnidadesARetener = assetType === "acciones" ? parseFloat(document.getElementById("porcUnidadesARetener").value) : 0;
            const unidadesIniciales = parseFloat(document.getElementById("unidadesIniciales").value);
            let precioInicial = parseFloat(document.getElementById("precioInicial").value);
            const margenInicialContrato = assetType === "futuros" ? parseFloat(document.getElementById("margenInicialContrato").value) : 0;
            const margenMantenimientoContrato = assetType === "futuros" ? parseFloat(document.getElementById("margenMantenimientoContrato").value) : 0;
            const comisionContrato = assetType === "futuros" ? parseFloat(document.getElementById("comisionContrato").value) : 0;
            const tamanoTick = assetType === "futuros" ? parseFloat(document.getElementById("tamanoTick").value) : 0;
            const valorTick = assetType === "futuros" ? parseFloat(document.getElementById("valorTick").value) : 0;
            const fixedUnitsToAdd = parseFloat(document.getElementById("fixedUnitsToAdd").value);
            const fixedPctInitialCapitalToAdd = parseFloat(document.getElementById("fixedPctInitialCapitalToAdd").value);
            const resultsTableBody = document.getElementById("resultsTableBody");
            resultsTableBody.innerHTML = "";
            if (isNaN(capitalMaximo) || capitalMaximo <= 0 || isNaN(pctCambio) || pctCambio <= 0 || pctCambio >= 100 || isNaN(precioLimite) || precioLimite <= 0 || isNaN(gananciaDeseada) || gananciaDeseada <= 0 || isNaN(unidadesIniciales) || unidadesIniciales <= 0 || isNaN(precioInicial) || precioInicial <= 0) {
                addMessageRow("Error: Por favor, introduce valores v√°lidos y positivos en todos los campos. Los porcentajes deben estar entre 0.1 y 99.9.", "error");
                document.getElementById("riskAnalysisSection").style.display = "none";
                return;
            }
            if (assetType === "acciones" && (isNaN(porcUnidadesARetener) || porcUnidadesARetener < 0 || porcUnidadesARetener >= 100)) {
                addMessageRow("Error: El porcentaje de acciones en stake debe ser un valor v√°lido entre 0 y 99.9.", "error");
                document.getElementById("riskAnalysisSection").style.display = "none";
                return;
            }
            if (assetType === "futuros") {
                if (isNaN(margenInicialContrato) || margenInicialContrato <= 0 || isNaN(margenMantenimientoContrato) || margenMantenimientoContrato <= 0 || isNaN(comisionContrato) || comisionContrato < 0 || isNaN(tamanoTick) || tamanoTick <= 0 || isNaN(valorTick) || valorTick <= 0) {
                    addMessageRow("Error: Por favor, introduce valores v√°lidos y positivos para los campos de Futuros (Margen, Comisi√≥n, Tick).", "error");
                    document.getElementById("riskAnalysisSection").style.display = "none";
                    return;
                }
                if (margenMantenimientoContrato >= margenInicialContrato) {
                    addMessageRow("Error: El Margen de Mantenimiento por Contrato debe ser menor que el Margen Inicial por Contrato.", "error");
                    document.getElementById("riskAnalysisSection").style.display = "none";
                    return;
                }
                precioInicial = roundToTick(precioInicial, tamanoTick);
                precioLimite = roundToTick(precioLimite, tamanoTick);
            }
            if (additionStrategy === "fixedUnits" && (isNaN(fixedUnitsToAdd) || fixedUnitsToAdd <= 0)) {
                addMessageRow('Error: Para "Mismo N√∫mero de Unidades por Fase", las unidades a a√±adir deben ser un valor positivo.', "error");
                document.getElementById("riskAnalysisSection").style.display = "none";
                return;
            }
            if (additionStrategy === "fixedPctInitialCapital" && (isNaN(fixedPctInitialCapitalToAdd) || fixedPctInitialCapitalToAdd <= 0 || fixedPctInitialCapitalToAdd > 100)) {
                addMessageRow('Error: Para "Porcentaje Fijo del Capital Inicial por Fase", el porcentaje debe ser entre 0.1 y 100.', "error");
                document.getElementById("riskAnalysisSection").style.display = "none";
                return;
            }
            let capitalActual = capitalMaximo;
            let unidadesTotales = 0;
            let inversionAcumulada = 0;
            let precioPromedio = precioInicial;
            let precioAnterior = precioInicial;
            let operacionCount = 0;
            let hasMarginCallOccurred = false;
            let totalComisiones = 0;
            let inversionInicialReal = 0;
            let margenReqPrimeraFase = 0;
            let comisionPrimeraFase = unidadesIniciales * comisionContrato;
            if (assetType === "acciones") {
                inversionInicialReal = unidadesIniciales * precioInicial;
                if (inversionInicialReal > capitalActual) {
                    addMessageRow(`Error: La inversi√≥n inicial (${formatCurrency(inversionInicialReal)}) excede el capital/margen m√°ximo total (${formatCurrency(capitalActual)}). Ajusta tu capital o la cantidad de unidades iniciales.`, "error");
                    document.getElementById("riskAnalysisSection").style.display = "none";
                    return;
                }
                capitalActual -= inversionInicialReal;
                inversionAcumulada = inversionInicialReal;
            } else {
                margenReqPrimeraFase = unidadesIniciales * margenInicialContrato;
                if (margenReqPrimeraFase + comisionPrimeraFase > capitalActual) {
                    addMessageRow(`Error: El margen inicial requerido para la 1¬™ operaci√≥n (${formatCurrency(margenReqPrimeraFase)}) m√°s comisiones (${formatCurrency(comisionPrimeraFase)}) excede el Capital/Margen M√°ximo Total (${formatCurrency(capitalActual)}).`, "error");
                    document.getElementById("riskAnalysisSection").style.display = "none";
                    return;
                }
                capitalActual -= margenReqPrimeraFase + comisionPrimeraFase;
                inversionAcumulada = margenReqPrimeraFase;
                totalComisiones += comisionPrimeraFase;
            }
            unidadesTotales = unidadesIniciales;
            let cantidadUnidadesARetener = assetType === "acciones" ? unidadesTotales * (porcUnidadesARetener / 100) : 0;
            let unidadesACerrar = unidadesTotales - cantidadUnidadesARetener;
            let precioObjetivoParaCerrar;
            let gananciaTotalEsperada;
            if (assetType === "acciones") {
                precioObjetivoParaCerrar = precioPromedio * (1 + gananciaDeseada / 100);
                gananciaTotalEsperada = unidadesACerrar * precioObjetivoParaCerrar - inversionAcumulada * (unidadesACerrar / unidadesTotales);
            } else {
                if (operationType === "long") {
                    precioObjetivoParaCerrar = precioPromedio * (1 + gananciaDeseada / 100);
                    gananciaTotalEsperada = unidadesACerrar * (precioObjetivoParaCerrar - precioPromedio) * (valorTick / tamanoTick) - unidadesACerrar * comisionContrato;
                } else {
                    precioObjetivoParaCerrar = precioPromedio * (1 - gananciaDeseada / 100);
                    gananciaTotalEsperada = unidadesACerrar * (precioPromedio - precioObjetivoParaCerrar) * (valorTick / tamanoTick) - unidadesACerrar * comisionContrato;
                }
            }
            if (gananciaTotalEsperada < 0) gananciaTotalEsperada = 0;
            const headerCount = parseInt(document.getElementById("tableHeaders").dataset.columns || 13, 10);
            let firstRowCells = [];
            if (assetType === "acciones") {
                firstRowCells = [ "1¬™ Compra", formatNumber(unidadesIniciales, 0), formatNumber(unidadesTotales, 2), formatCurrency(capitalActual), `${formatNumber(porcUnidadesARetener, 1)}% (${formatNumber(cantidadUnidadesARetener, 2)})`, formatCurrency(precioInicial), formatCurrency(inversionInicialReal), formatCurrency(inversionAcumulada), formatCurrency(precioPromedio), `<b>${formatCurrency(precioObjetivoParaCerrar)}</b>`, formatCurrency(gananciaTotalEsperada), "-", formatNumber(unidadesACerrar, 2), ];
            } else {
                firstRowCells = [ operationType === "long" ? "1¬™ Compra Long" : "1¬™ Venta Corto", formatNumber(unidadesIniciales, 0), formatNumber(unidadesTotales, 0), formatCurrency(capitalActual), formatCurrency(unidadesTotales * margenMantenimientoContrato), formatCurrency(precioInicial), formatCurrency(margenReqPrimeraFase), formatCurrency(inversionAcumulada), formatCurrency(precioPromedio), `<b>${formatCurrency(roundToTick(precioObjetivoParaCerrar, tamanoTick))}</b>`, formatCurrency(gananciaTotalEsperada), "-", formatNumber(unidadesACerrar, 0), ];
            }
            addResultRow(firstRowCells);
            let currentPrecio = precioInicial;
            const factorCambioLong = 1 - pctCambio / 100;
            const factorCambioShort = 1 + pctCambio / 100;
            while (operacionCount < 500) {
                operacionCount++;
                let proximoPrecioOperacion;
                if (operationType === "long") {
                    proximoPrecioOperacion = currentPrecio * factorCambioLong;
                } else {
                    proximoPrecioOperacion = currentPrecio * factorCambioShort;
                }
                if (assetType === "futuros") {
                    proximoPrecioOperacion = roundToTick(proximoPrecioOperacion, tamanoTick);
                }
                if (operationType === "long" && proximoPrecioOperacion <= 0.001) {
                    proximoPrecioOperacion = 0.001;
                }
                const willHitLimit = operationType === "long" ? proximoPrecioOperacion < precioLimite : proximoPrecioOperacion > precioLimite;
                if ((operationType === "long" && proximoPrecioOperacion < precioLimite) || (operationType === "short" && proximoPrecioOperacion > precioLimite)) {
                    const message = operationType === "long" ? `Simulaci√≥n finalizada: El precio proyectado (${formatCurrency(proximoPrecioOperacion)}) est√° por debajo del <strong>Precio L√≠mite de Compra</strong> (${formatCurrency(precioLimite)}).` : `Simulaci√≥n finalizada: El precio proyectado (${formatCurrency(proximoPrecioOperacion)}) est√° por encima del <strong>Precio L√≠mite de Venta</strong> (${formatCurrency(precioLimite)}).`;
                    addMessageRow(message, "warning");
                    break;
                }
                let unidadesAdicionales = 0;
                let inversionEnFase = 0;
                let comisionEnFase = 0;
                if (additionStrategy === "distributeCapital") {
                    let tempPrecioForEstimate = proximoPrecioOperacion;
                    let estimatedRemainingOperations = 0;
                    for (let i = 0; i < 200 && tempPrecioForEstimate > 0.001; i++) {
                        let nextTempPrice = operationType === "long" ? tempPrecioForEstimate * factorCambioLong : tempPrecioForEstimate * factorCambioShort;
                        if (assetType === "futuros") {
                            nextTempPrice = roundToTick(nextTempPrice, tamanoTick);
                        }
                        const tempWillHitLimit = operationType === "long" ? nextTempPrice < precioLimite : nextTempPrice > precioLimite;
                        if (tempWillHitLimit) break;
                        estimatedRemainingOperations++;
                        tempPrecioForEstimate = nextTempPrice;
                    }
                    const avgCost = assetType === "acciones" ? proximoPrecioOperacion : margenInicialContrato + comisionContrato;
                    const maxOpsByCapital = Math.max(1, Math.floor(capitalActual / avgCost)) || 1;
                    const effectiveFutureOperations = Math.min(Math.max(1, estimatedRemainingOperations), maxOpsByCapital);
                    const capitalToDistribute = capitalActual;
                    const inversionObjetivoPorFase = capitalToDistribute / effectiveFutureOperations;
                    if (assetType === "acciones") {
                        unidadesAdicionales = Math.floor(inversionObjetivoPorFase / proximoPrecioOperacion);
                    } else {
                        unidadesAdicionales = Math.floor(inversionObjetivoPorFase / (margenInicialContrato + comisionContrato));
                    }
                } else if (additionStrategy === "fixedUnits") {
                    unidadesAdicionales = fixedUnitsToAdd;
                } else if (additionStrategy === "fixedPctInitialCapital") {
                    const inversionObjetivoPorFasePct = capitalMaximo * (fixedPctInitialCapitalToAdd / 100);
                    if (assetType === "acciones") {
                        unidadesAdicionales = Math.floor(inversionObjetivoPorFasePct / proximoPrecioOperacion);
                    } else {
                        unidadesAdicionales = Math.floor(inversionObjetivoPorFasePct / (margenInicialContrato + comisionContrato));
                    }
                } else if (additionStrategy === "growingUnits") {
                    unidadesAdicionales = unidadesIniciales + operacionCount;
                }
                unidadesAdicionales = Math.max(0, unidadesAdicionales);
                if (assetType === "acciones") {
                    inversionEnFase = unidadesAdicionales * proximoPrecioOperacion;
                    comisionEnFase = 0;
                } else {
                    inversionEnFase = unidadesAdicionales * margenInicialContrato;
                    comisionEnFase = unidadesAdicionales * comisionContrato;
                }
                if (unidadesAdicionales === 0 || inversionEnFase + comisionEnFase > capitalActual) {
                    addMessageRow(`Simulaci√≥n finalizada: Capital/Margen insuficiente (${formatCurrency(capitalActual)}) para a√±adir m√°s unidades/contratos.`, "warning");
                    break;
                }
                const prevInversion = inversionAcumulada;
                const prevUnidades = unidadesTotales;
                capitalActual -= inversionEnFase + comisionEnFase;
                unidadesTotales += unidadesAdicionales;
                totalComisiones += comisionEnFase;
                if (assetType === "acciones") {
                    inversionAcumulada += inversionEnFase;
                    precioPromedio = unidadesTotales > 0 ? inversionAcumulada / unidadesTotales : 0;
                } else {
                    inversionAcumulada += inversionEnFase;
                    precioPromedio = unidadesTotales > 0 ? (precioPromedio * prevUnidades + proximoPrecioOperacion * unidadesAdicionales) / unidadesTotales : 0;
                }
                currentPrecio = proximoPrecioOperacion;
                const currentUnidadesARetener = assetType === "acciones" ? unidadesTotales * (porcUnidadesARetener / 100) : 0;
                unidadesACerrar = unidadesTotales - currentUnidadesARetener;
                let isMarginCall = false;
                if (assetType === "futuros") {
                    const margenMantenimientoTotalReq = unidadesTotales * margenMantenimientoContrato;
                    if (capitalActual < margenMantenimientoTotalReq && !hasMarginCallOccurred) {
                        isMarginCall = true;
                        hasMarginCallOccurred = true;
                    }
                }
                if (assetType === "acciones") {
                    precioObjetivoParaCerrar = precioPromedio * (1 + gananciaDeseada / 100);
                    gananciaTotalEsperada = unidadesACerrar * precioObjetivoParaCerrar - inversionAcumulada * (unidadesACerrar / unidadesTotales);
                } else {
                    if (operationType === "long") {
                        precioObjetivoParaCerrar = precioPromedio * (1 + gananciaDeseada / 100);
                        gananciaTotalEsperada = unidadesACerrar * (precioObjetivoParaCerrar - precioPromedio) * (valorTick / tamanoTick) - unidadesACerrar * comisionContrato;
                    } else {
                        precioObjetivoParaCerrar = precioPromedio * (1 - gananciaDeseada / 100);
                        gananciaTotalEsperada = unidadesACerrar * (precioPromedio - precioObjetivoParaCerrar) * (valorTick / tamanoTick) - unidadesACerrar * comisionContrato;
                    }
                }
                if (gananciaTotalEsperada < 0) gananciaTotalEsperada = 0;
                let cells = [];
                if (assetType === "acciones") {
                    cells = [ `A√±adir Compra #${operacionCount}`, formatNumber(unidadesAdicionales, 2), formatNumber(unidadesTotales, 2), formatCurrency(capitalActual), `${formatNumber(porcUnidadesARetener, 1)}% (${formatNumber(currentUnidadesARetener,2)})`, formatCurrency(proximoPrecioOperacion), formatCurrency(inversionEnFase), formatCurrency(inversionAcumulada), formatCurrency(precioPromedio), `<b>${formatCurrency(precioObjetivoParaCerrar)}</b>`, formatCurrency(gananciaTotalEsperada), `${formatNumber(pctCambio)}%`, formatNumber(unidadesACerrar, 2), ];
                } else {
                    cells = [ operationType === "long" ? `Recompra Long #${operacionCount}` : `A√±adir Corto #${operacionCount}`, formatNumber(unidadesAdicionales, 0), formatNumber(unidadesTotales, 0), formatCurrency(capitalActual), formatCurrency(unidadesTotales * margenMantenimientoContrato), formatCurrency(proximoPrecioOperacion), formatCurrency(inversionEnFase), formatCurrency(inversionAcumulada), formatCurrency(precioPromedio), `<b>${formatCurrency(roundToTick(precioObjetivoParaCerrar, tamanoTick))}</b>`, formatCurrency(gananciaTotalEsperada), `${formatNumber(pctCambio)}%`, formatNumber(unidadesACerrar, 0), ];
                }
                addResultRow(cells, isMarginCall);
            }
            showRiskAnalysis(assetType, operationType, pctCambio, capitalMaximo, capitalActual);
        }

        function showRiskAnalysis(assetType, operationType, pctCambio, capitalInicial, capitalFinal) {
            const section = document.getElementById("riskAnalysisSection");
            section.style.display = "block";
            const title = document.getElementById("riskAnalysisTitle");
            title.textContent = `An√°lisis de Riesgos Clave (${assetType === "acciones" ? "Acciones (Estrategia Long)" : operationType === "long" ? "Futuros Long" : "Futuros Short"})`;
            let html = "<ul>";
            if (assetType === "acciones") {
                html += `
                    <li><strong>Gesti√≥n del Capital:</strong> Se distribuye el capital en m√∫ltiples compras sucesivas cuando el precio cae el <strong>${formatNumber(pctCambio)}%</strong>, hasta agotar el capital m√°ximo <strong>${formatCurrency(capitalInicial)}</strong> o alcanzar el precio l√≠mite. Capital restante final: <strong>${formatCurrency(capitalFinal)}</strong>.</li>
                    <li><strong>Dependencia de la Recuperaci√≥n:</strong> El √©xito depende de que el precio se recupere y supere el precio de venta necesario para cerrar con ganancia.</li>
                    <li><strong>Riesgo de "A√±adir a Posici√≥n Perdedora":</strong> Promediar a la baja puede amplificar p√©rdidas si la tendencia bajista es fuerte.</li>
                    <li><strong>Inmovilizaci√≥n de Capital:</strong> Si el precio no se recupera, el capital queda bloqueado limitando otras inversiones.</li>
                `;
            } else {
                html += `
                    <li><strong>Gesti√≥n del Margen/Capital:</strong> Se usa el capital/margen m√°ximo para abrir y a√±adir contratos, considerando margen inicial y mantenimiento.</li>
                    <li><strong>Riesgo de Margin Call:</strong> Si el capital cae bajo el margen de mantenimiento, se puede requerir aportar m√°s dinero o cerrar posiciones a p√©rdida.</li>
                    <li><strong>Comisiones:</strong> Afectan la rentabilidad en operaciones frecuentes y m√∫ltiples contratos.</li>
                    <li><strong>Dependencia de Direcci√≥n del Mercado:</strong> En operaciones short, el precio debe bajar; en long, subir para obtener beneficios.</li>
                    <li><strong>Volatilidad:</strong> Los futuros pueden tener movimientos r√°pidos que amplifican ganancias o p√©rdidas, aumentando el riesgo.</li>
                `;
            }
            html += "</ul>";
            document.getElementById("riskContent").innerHTML = html;
        }
    </script>
</body>
</html>