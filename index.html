<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Estrategia de Inversi√≥n a Largo Plazo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f7f9;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: auto;
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        label {
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9em;
        }
        input[type="number"] {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
        }
        button {
            grid-column: 1 / -1;
            padding: 12px 20px;
            font-size: 1.1em;
            font-weight: bold;
            color: #fff;
            background-color: #3498db;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px 12px;
            text-align: right;
            white-space: nowrap;
        }
        th {
            background-color: #ecf0f1;
            color: #2c3e50;
            font-weight: bold;
        }
        tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .risk-analysis {
            margin-top: 30px;
            padding: 15px;
            background-color: #fffbe6;
            border-left: 5px solid #f39c12;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Simulador de Estrategia de Inversi√≥n üìà</h1>
    <p>Introduce los par√°metros de tu estrategia para calcular la distribuci√≥n de la inversi√≥n, simular cada fase y determinar los precios de venta necesarios.</p>
    
    <div id="input-section">
        <h2>Par√°metros de la Simulaci√≥n</h2>
        <form id="simulationForm" class="form-grid">
            <div class="form-group">
                <label for="capitalMaximo">Capital M√°ximo Total (‚Ç¨):</label>
                <input type="number" id="capitalMaximo" value="10000" step="1000" min="0">
            </div>
            <div class="form-group">
                <label for="caidaRecompra">% Ca√≠da para Recompra (PCx):</label>
                <input type="number" id="caidaRecompra" value="10" step="0.5" min="0.1" max="99.9">
            </div>
            <div class="form-group">
                <label for="precioMinimo">Precio M√≠nimo de Compra (‚Ç¨):</label>
                <input type="number" id="precioMinimo" value="5" step="0.1" min="0.01">
            </div>
            <div class="form-group">
                <label for="gananciaDeseada">% Ganancia Adicional Deseado:</label>
                <input type="number" id="gananciaDeseada" value="15" step="1" min="0.1">
            </div>
            <div class="form-group">
                <label for="accionesGratuitas">% Acciones 'Gratuitas' a Conservar:</label>
                <input type="number" id="accionesGratuitas" value="10" step="1" min="0" max="99.9">
            </div>
             <div class="form-group">
                <label for="accionesIniciales">Acciones (Primera Compra):</label>
                <input type="number" id="accionesIniciales" value="50" min="1">
            </div>
            <div class="form-group">
                <label for="precioInicial">Precio por Acci√≥n (Primera Compra) (‚Ç¨):</label>
                <input type="number" id="precioInicial" value="20" step="0.1" min="0.01">
            </div>
            <button type="button" onclick="runSimulation()">Calcular Simulaci√≥n</button>
        </form>
    </div>

    <div id="results-section">
        <h2>Tabla de Resultados</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Fase de Compra</th>
                        <th>Acciones Compradas</th>
                        <th>Acciones Totales</th>
                        <th>Capital Restante (‚Ç¨)</th>
                        <th>Acciones 'Gratuitas' (% y Cantidad)</th>
                        <th>Precio de la Acci√≥n (‚Ç¨)</th>
                        <th>Inversi√≥n en Fase (‚Ç¨)</th>
                        <th>Inversi√≥n Acumulada (‚Ç¨)</th>
                        <th>PPM (‚Ç¨)</th>
                        <th>Precio Venta Necesario (‚Ç¨)</th>
                        <th>Ganancia Total al Vender (‚Ç¨)</th>
                        <th>Ca√≠da % (desde anterior)</th>
                        <th>Acciones a Vender</th>
                    </tr>
                </thead>
                <tbody id="resultsTableBody">
                    </tbody>
            </table>
        </div>
    </div>
    
    <div id="riskAnalysisSection" class="risk-analysis" style="display:none;">
        <h2>An√°lisis de Riesgos Clave</h2>
        <div id="riskContent"></div>
    </div>

</div>

<script>
function formatCurrency(value) {
    if (isNaN(value) || !isFinite(value)) {
        return '-';
    }
    return value.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' });
}

function formatNumber(value, decimals = 2) {
    if (isNaN(value) || !isFinite(value)) {
        return '-';
    }
    return value.toLocaleString('es-ES', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
}

function runSimulation() {
    // 1. OBTENER PAR√ÅMETROS DEL FORMULARIO
    const capitalMaximo = parseFloat(document.getElementById('capitalMaximo').value);
    const pcx = parseFloat(document.getElementById('caidaRecompra').value);
    const precioMinimo = parseFloat(document.getElementById('precioMinimo').value);
    const gananciaDeseada = parseFloat(document.getElementById('gananciaDeseada').value);
    const porcAccionesGratuitas = parseFloat(document.getElementById('accionesGratuitas').value);
    const accionesIniciales = parseFloat(document.getElementById('accionesIniciales').value);
    const precioInicial = parseFloat(document.getElementById('precioInicial').value);

    const resultsTableBody = document.getElementById('resultsTableBody');
    resultsTableBody.innerHTML = ''; // Limpiar resultados anteriores

    // Basic input validation
    if (isNaN(capitalMaximo) || capitalMaximo <= 0 ||
        isNaN(pcx) || pcx <= 0 || pcx >= 100 || 
        isNaN(precioMinimo) || precioMinimo <= 0 ||
        isNaN(gananciaDeseada) || gananciaDeseada <= 0 || 
        isNaN(porcAccionesGratuitas) || porcAccionesGratuitas < 0 || porcAccionesGratuitas >= 100 || 
        isNaN(accionesIniciales) || accionesIniciales <= 0 ||
        isNaN(precioInicial) || precioInicial <= 0) {
        resultsTableBody.innerHTML = `<tr><td colspan="13" style="color: red; text-align: center;">Error: Por favor, introduce valores v√°lidos y positivos en todos los campos. Los porcentajes deben estar entre 0 y 100 (excluyendo 100).</td></tr>`;
        document.getElementById('riskAnalysisSection').style.display = 'none';
        return;
    }

    let capitalRestante = capitalMaximo;
    let accionesTotales = 0;
    let inversionAcumulada = 0;
    let precioAnterior = 0;
    let recompraCount = 0; 
    
    // 2. FASE 0: PRIMERA COMPRA
    const inversionInicial = accionesIniciales * precioInicial;
    if (inversionInicial > capitalMaximo) {
        resultsTableBody.innerHTML = `<tr><td colspan="13" style="color: red; text-align: center;">Error: La inversi√≥n inicial (${formatCurrency(inversionInicial)}) excede el capital m√°ximo total (${formatCurrency(capitalMaximo)}). Ajusta el capital m√°ximo o la primera compra.</td></tr>`;
        document.getElementById('riskAnalysisSection').style.display = 'none';
        return;
    }

    capitalRestante -= inversionInicial;
    accionesTotales = accionesIniciales;
    inversionAcumulada = inversionInicial;
    let ppm = precioInicial;
    precioAnterior = precioInicial;

    // Calcular objetivos de venta para la Fase 0
    let capitalObjetivo = inversionAcumulada * (1 + gananciaDeseada / 100);
    let cantidadAccionesGratuitas = accionesTotales * (porcAccionesGratuitas / 100);
    let accionesAVender = accionesTotales - cantidadAccionesGratuitas;
    let precioVentaNecesario = accionesAVender > 0 ? capitalObjetivo / accionesAVender : 0;
    
    let gananciaTotalEsperada = capitalObjetivo - inversionAcumulada;
    if (gananciaTotalEsperada < 0) gananciaTotalEsperada = 0; 

    // A√±adir fila a la tabla
    let newRow = `<tr>
        <td>Primera Compra</td>
        <td>${formatNumber(accionesIniciales, 0)}</td>
        <td>${formatNumber(accionesTotales, 2)}</td>
        <td>${formatCurrency(capitalRestante)}</td>
        <td>${porcAccionesGratuitas}% (${formatNumber(cantidadAccionesGratuitas, 2)})</td>
        <td>${formatCurrency(precioInicial)}</td>
        <td>${formatCurrency(inversionInicial)}</td>
        <td>${formatCurrency(inversionAcumulada)}</td>
        <td>${formatCurrency(ppm)}</td>
        <td><b>${formatCurrency(precioVentaNecesario)}</b></td>
        <td>${formatCurrency(gananciaTotalEsperada)}</td>
        <td>-</td>
        <td>${formatNumber(accionesAVender, 2)}</td>
    </tr>`;
    resultsTableBody.innerHTML += newRow;

    // 3. FASES DE RECOMPRA (PC1, PC2, ...) - Ahora din√°mico y optimizado
    while (true) {
        const proximoPrecioRecompra = precioAnterior * (1 - pcx / 100);

        // Condici√≥n de parada: Precio M√≠nimo Alcanzado
        if (proximoPrecioRecompra < precioMinimo) {
            resultsTableBody.innerHTML += `<tr><td colspan="13" style="color: orange; text-align: center;">Simulaci√≥n finalizada: El precio de recompra proyectado (${formatCurrency(proximoPrecioRecompra)}) es inferior al "Precio M√≠nimo de Compra" (${formatCurrency(precioMinimo)}).</td></tr>`;
            break;
        }

        // Determinar cu√°nto capital se puede invertir en esta fase.
        // Se invierte todo el capital restante que sea posible, siempre que permita comprar al menos 1 acci√≥n.
        let inversionEnFase = capitalRestante;

        // Si el capital restante es demasiado bajo para comprar incluso 1 acci√≥n al proximoPrecioRecompra
        if (capitalRestante < proximoPrecioRecompra) {
            resultsTableBody.innerHTML += `<tr><td colspan="13" style="color: orange; text-align: center;">Simulaci√≥n finalizada: Capital insuficiente para comprar al menos 1 acci√≥n adicional al precio de ${formatCurrency(proximoPrecioRecompra)}.</td></tr>`;
            break;
        }

        const accionesCompradas = inversionEnFase / proximoPrecioRecompra;
        
        // Si las acciones compradas son insignificantes, detener (por ejemplo, menos de 0.001 de una acci√≥n)
        if (accionesCompradas < 0.001) { 
             resultsTableBody.innerHTML += `<tr><td colspan="13" style="color: orange; text-align: center;">Simulaci√≥n finalizada: Cantidad de acciones a comprar insignificante o capital agotado para compras futuras.</td></tr>`;
             break;
        }

        recompraCount++;

        // Actualizar totales
        capitalRestante -= inversionEnFase;
        accionesTotales += accionesCompradas;
        inversionAcumulada += inversionEnFase;
        ppm = inversionAcumulada / accionesTotales;
        precioAnterior = proximoPrecioRecompra; // El precio de la recompra actual es el "precio anterior" para la siguiente fase

        // Calcular objetivos de venta para la fase actual
        capitalObjetivo = inversionAcumulada * (1 + gananciaDeseada / 100);
        cantidadAccionesGratuitas = accionesTotales * (porcAccionesGratuitas / 100);
        accionesAVender = accionesTotales - cantidadAccionesGratuitas;
        precioVentaNecesario = accionesAVender > 0 ? capitalObjetivo / accionesAVender : 0;

        gananciaTotalEsperada = capitalObjetivo - inversionAcumulada;
        if (gananciaTotalEsperada < 0) gananciaTotalEsperada = 0; 

        // A√±adir fila a la tabla
        newRow = `<tr>
            <td>Recompra PC${recompraCount}</td>
            <td>${formatNumber(accionesCompradas, 2)}</td>
            <td>${formatNumber(accionesTotales, 2)}</td>
            <td>${formatCurrency(capitalRestante)}</td>
            <td>${porcAccionesGratuitas}% (${formatNumber(cantidadAccionesGratuitas, 2)})</td>
            <td>${formatCurrency(proximoPrecioRecompra)}</td>
            <td>${formatCurrency(inversionEnFase)}</td>
            <td>${formatCurrency(inversionAcumulada)}</td>
            <td>${formatCurrency(ppm)}</td>
            <td><b>${formatCurrency(precioVentaNecesario)}</b></td>
            <td>${formatCurrency(gananciaTotalEsperada)}</td>
            <td>${formatNumber(pcx)}%</td>
            <td>${formatNumber(accionesAVender, 2)}</td>
        </tr>`;
        resultsTableBody.innerHTML += newRow;

        // Condici√≥n de parada: Capital Agotado (despu√©s de realizar la compra)
        if (capitalRestante <= 0.01) { // Usar un peque√±o umbral para flotantes para evitar errores de redondeo
            resultsTableBody.innerHTML += `<tr><td colspan="13" style="color: orange; text-align: center;">Simulaci√≥n finalizada: Capital agotado.</td></tr>`;
            break;
        }
    }
    
    // 4. MOSTRAR AN√ÅLISIS DE RIESGOS
    document.getElementById('riskAnalysisSection').style.display = 'block';
    document.getElementById('riskContent').innerHTML = `
        <ul>
            <li><strong>Gesti√≥n del Capital:</strong> La estrategia realiza recompras sucesivas al cumplir el criterio de "ca√≠da para recompra", invirtiendo el capital restante en cada fase hasta que este se agote o el precio alcance el m√≠nimo. El **capital m√°ximo disponible (${formatCurrency(capitalMaximo)})** se asignar√° a compras en cada fase de ca√≠da. El capital restante final es de <strong>${formatCurrency(capitalRestante)}</strong>, que es el remanente no utilizado o no asignable.</li>
            <li><strong>Riesgo de Concentraci√≥n:</strong> Al invertir repetidamente en un √∫nico activo que est√° cayendo, aumentas la concentraci√≥n y el riesgo espec√≠fico de esa empresa o sector. Una falta de recuperaci√≥n a largo plazo podr√≠a resultar en una p√©rdida significativa del capital invertido.</li>
            <li><strong>Dependencia de la Recuperaci√≥n (Riesgo "No Vender con P√©rdidas"):</strong> El principio de no vender por debajo del Precio Promedio de Compra (PPM) te protege de realizar p√©rdidas, pero te ata al activo indefinidamente si no recupera su valor. El capital permanece bloqueado, generando un alto coste de oportunidad. El √©xito de la estrategia depende 100% de que el precio del activo eventualmente supere tu <strong>Precio de Venta Necesario</strong>.</li>
            <li><strong>Riesgo de "Cuchillo que Cae" (Catching a Falling Knife):</strong> Comprar activos en ca√≠das sucesivas es arriesgado. Si la ca√≠da se debe a problemas fundamentales del activo (y no a una correcci√≥n de mercado), el precio podr√≠a no recuperarse nunca, invalidando la premisa de la estrategia.</li>
        </ul>
    `;
}

// Ejecutar una simulaci√≥n inicial al cargar la p√°gina con los valores por defecto
window.onload = runSimulation;
</script>

</body>
</html>